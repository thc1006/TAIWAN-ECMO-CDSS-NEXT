{
  "analysis_timestamp": "2025-09-30",
  "nirs_risk_models": {
    "file": "nirs/risk_models.py",
    "lines": 506,
    "ml_architecture": {
      "model_class": "NIRSECMORiskModel",
      "ecmo_types": ["VA", "VV"],
      "base_models": {
        "logistic_regression": {
          "class": "LogisticRegression",
          "params": {
            "random_state": 42,
            "max_iter": 1000
          },
          "requires_scaling": true,
          "scaler": "StandardScaler"
        },
        "random_forest": {
          "class": "RandomForestClassifier",
          "params": {
            "n_estimators": 100,
            "random_state": 42
          },
          "requires_scaling": false
        },
        "gradient_boosting": {
          "class": "GradientBoostingClassifier",
          "params": {
            "random_state": 42
          },
          "requires_scaling": false,
          "note": "Uses default parameters from sklearn"
        }
      },
      "calibration": {
        "method": "CalibratedClassifierCV",
        "calibration_method": "isotonic",
        "cv_folds": 3,
        "description": "Applied to best-performing base model"
      }
    },
    "features": {
      "va_ecmo": {
        "count": 24,
        "categories": {
          "demographics": ["age_years", "weight_kg", "bmi"],
          "blood_gases": ["pre_ecmo_lactate", "pre_ecmo_ph", "pre_ecmo_pco2", "pre_ecmo_po2"],
          "cardiac": ["cardiac_arrest", "cpr_duration_min", "inotrope_score", "lvef_pre_ecmo", "mitral_regurg_severity", "aortic_regurg_severity"],
          "nirs_baseline": ["cerebral_so2_baseline", "renal_so2_baseline", "somatic_so2_baseline"],
          "nirs_24h": ["cerebral_so2_min_24h", "renal_so2_min_24h", "somatic_so2_min_24h"],
          "nirs_derived": ["nirs_trend_cerebral", "nirs_trend_renal", "nirs_variability"],
          "organ_function": ["creatinine_pre", "bilirubin_pre", "platelet_count_pre"]
        },
        "complete_list": [
          "age_years", "weight_kg", "bmi",
          "pre_ecmo_lactate", "pre_ecmo_ph", "pre_ecmo_pco2", "pre_ecmo_po2",
          "cardiac_arrest", "cpr_duration_min", "inotrope_score",
          "cerebral_so2_baseline", "renal_so2_baseline", "somatic_so2_baseline",
          "cerebral_so2_min_24h", "renal_so2_min_24h", "somatic_so2_min_24h",
          "nirs_trend_cerebral", "nirs_trend_renal", "nirs_variability",
          "creatinine_pre", "bilirubin_pre", "platelet_count_pre",
          "lvef_pre_ecmo", "mitral_regurg_severity", "aortic_regurg_severity"
        ]
      },
      "vv_ecmo": {
        "count": 25,
        "categories": {
          "demographics": ["age_years", "weight_kg", "bmi"],
          "blood_gases": ["pre_ecmo_ph", "pre_ecmo_pco2", "pre_ecmo_po2", "pre_ecmo_fio2"],
          "respiratory": ["murray_score", "peep_level", "plateau_pressure", "resp_compliance", "driving_pressure", "oxygenation_index"],
          "interventions": ["prone_positioning", "neuromuscular_blockade"],
          "nirs_baseline": ["cerebral_so2_baseline", "renal_so2_baseline", "somatic_so2_baseline"],
          "nirs_24h": ["cerebral_so2_min_24h", "renal_so2_min_24h", "somatic_so2_min_24h"],
          "nirs_derived": ["nirs_trend_cerebral", "nirs_trend_renal", "nirs_variability"],
          "comorbidities": ["immunocompromised", "chronic_lung_disease", "pneumonia_type"]
        },
        "complete_list": [
          "age_years", "weight_kg", "bmi",
          "pre_ecmo_ph", "pre_ecmo_pco2", "pre_ecmo_po2", "pre_ecmo_fio2",
          "murray_score", "peep_level", "plateau_pressure",
          "prone_positioning", "neuromuscular_blockade",
          "cerebral_so2_baseline", "renal_so2_baseline", "somatic_so2_baseline",
          "cerebral_so2_min_24h", "renal_so2_min_24h", "somatic_so2_min_24h",
          "nirs_trend_cerebral", "nirs_trend_renal", "nirs_variability",
          "immunocompromised", "chronic_lung_disease", "pneumonia_type",
          "resp_compliance", "driving_pressure", "oxygenation_index"
        ]
      }
    },
    "nirs_feature_engineering": {
      "nirs_trend_calculation": {
        "formula": "min_24h - baseline",
        "sites": ["cerebral", "renal", "somatic"],
        "description": "Calculates slope over first 24 hours",
        "code_line": 98
      },
      "nirs_variability": {
        "formula": "abs(cerebral_baseline - cerebral_min) / cerebral_baseline",
        "description": "Coefficient of variation for cerebral rSO2",
        "default_values": {
          "cerebral_so2_baseline": 70,
          "cerebral_so2_min_24h": 60
        },
        "code_line": 103
      },
      "nirs_adequacy_score": {
        "formula": "(cerebral*0.5 + renal*0.3 + somatic*0.2) / 100",
        "weights": {
          "cerebral": 0.5,
          "renal": 0.3,
          "somatic": 0.2
        },
        "default_values": {
          "cerebral_so2_baseline": 70,
          "renal_so2_baseline": 75,
          "somatic_so2_baseline": 70
        },
        "code_line": 106,
        "note": "Composite adequacy score, not used in final feature set"
      }
    },
    "risk_scores": {
      "save_ii_score": {
        "ecmo_type": "VA",
        "full_name": "Survival After Veno-Arterial ECMO Score",
        "components": [
          {
            "variable": "age",
            "cutoff_1": 38,
            "points_1": -2,
            "cutoff_2": 53,
            "points_2": -2,
            "code_line": 132
          },
          {
            "variable": "weight_kg",
            "cutoff": 65,
            "points": -3,
            "operator": "less_than",
            "code_line": 137
          },
          {
            "variable": "cardiac_arrest",
            "condition": "true",
            "points": -2,
            "code_line": 141
          },
          {
            "variable": "bicarbonate_pre",
            "cutoff": 15,
            "points": -3,
            "operator": "less_than",
            "code_line": 145,
            "note": "Only if available"
          }
        ],
        "interpretation": "Lower scores indicate worse prognosis"
      },
      "resp_score": {
        "ecmo_type": "VV",
        "full_name": "Respiratory ECMO Survival Prediction Score",
        "components": [
          {
            "variable": "age",
            "range_optimal": [18, 49],
            "points_optimal": 0,
            "cutoff_poor": 60,
            "points_poor": -3,
            "code_line": 155
          },
          {
            "variable": "immunocompromised",
            "condition": "true",
            "points": -2,
            "code_line": 160
          },
          {
            "variable": "vent_duration_pre_ecmo",
            "cutoff": 7,
            "points": -1,
            "operator": "greater_than",
            "code_line": 164,
            "note": "Days of ventilation before ECMO"
          }
        ],
        "interpretation": "Lower scores indicate worse prognosis"
      }
    },
    "training_strategy": {
      "data_split": {
        "validation_split": 0.2,
        "test_split": 0.0,
        "random_state": 42,
        "stratify": true,
        "stratify_variable": "y (survival outcome)"
      },
      "missing_value_handling": {
        "method": "fillna",
        "imputation": "median",
        "code_line": 197,
        "note": "Applied after feature selection"
      },
      "feature_scaling": {
        "method": "StandardScaler",
        "applied_to": "Logistic Regression only",
        "fit_on": "training set",
        "transform": "training and validation sets"
      },
      "model_selection": {
        "criterion": "maximum AUC-ROC",
        "candidates": ["logistic", "rf", "gbm"],
        "evaluation_set": "validation set",
        "code_line": 229
      },
      "ensemble": {
        "method": "single best model selection",
        "note": "Does NOT use voting/stacking ensemble"
      }
    },
    "evaluation_metrics": {
      "primary": {
        "metric": "AUC-ROC",
        "function": "roc_auc_score",
        "interpretation": "Area under ROC curve, 0.5-1.0"
      },
      "calibration": {
        "metric": "Brier Score",
        "function": "brier_score_loss",
        "interpretation": "Lower is better, 0-1 scale"
      },
      "calibration_curve": {
        "n_bins": 10,
        "normalize": false,
        "code_line": 360,
        "note": "Used for visualization"
      },
      "other_curves": {
        "roc_curve": "plots FPR vs TPR",
        "precision_recall_curve": "imported but not used"
      }
    },
    "explainability": {
      "method": "SHAP (SHapley Additive exPlanations)",
      "explainer_types": {
        "logistic": {
          "class": "shap.LinearExplainer",
          "input": "base_estimator from calibrated model",
          "data": "scaled training data",
          "code_line": 254
        },
        "tree_based": {
          "class": "shap.TreeExplainer",
          "input": "base model (RF or GBM)",
          "code_line": 260
        }
      },
      "output_format": {
        "shap_values": "array of feature contributions",
        "feature_names": "list of feature names",
        "feature_values": "actual patient values",
        "base_value": "expected value (baseline prediction)",
        "predicted_risk": "final probability"
      },
      "error_handling": {
        "fallback": "returns empty dict on failure",
        "code_line": 342
      }
    },
    "demo_data_generation": {
      "seed": 42,
      "n_patients": {
        "va_default": 500,
        "vv_default": 500
      },
      "distributions": {
        "age_years": {
          "distribution": "normal",
          "mean": 55,
          "std": 15,
          "clip_min": 18,
          "clip_max": 85
        },
        "weight_kg": {
          "distribution": "normal",
          "mean": 75,
          "std": 15,
          "clip_min": 40,
          "clip_max": 150
        },
        "bmi": {
          "distribution": "normal",
          "mean": 25,
          "std": 5,
          "clip_min": 15,
          "clip_max": 45
        },
        "cerebral_so2_baseline": {
          "distribution": "normal",
          "mean": 70,
          "std": 10,
          "clip_min": 40,
          "clip_max": 90
        },
        "renal_so2_baseline": {
          "distribution": "normal",
          "mean": 75,
          "std": 8,
          "clip_min": 50,
          "clip_max": 90
        },
        "somatic_so2_baseline": {
          "distribution": "normal",
          "mean": 70,
          "std": 8,
          "clip_min": 45,
          "clip_max": 85
        },
        "cerebral_so2_min_24h": {
          "distribution": "normal",
          "mean": 65,
          "std": 12,
          "clip_min": 30,
          "clip_max": 85
        },
        "renal_so2_min_24h": {
          "distribution": "normal",
          "mean": 70,
          "std": 10,
          "clip_min": 40,
          "clip_max": 85
        },
        "somatic_so2_min_24h": {
          "distribution": "normal",
          "mean": 65,
          "std": 10,
          "clip_min": 35,
          "clip_max": 80
        },
        "cardiac_arrest": {
          "distribution": "choice",
          "values": [true, false],
          "probabilities": [0.4, 0.6]
        },
        "cpr_duration_min": {
          "distribution": "exponential",
          "scale": 20,
          "clip_min": 0,
          "clip_max": 120
        },
        "pre_ecmo_lactate": {
          "distribution": "exponential",
          "scale": 3,
          "clip_min": 0.5,
          "clip_max": 20
        },
        "lvef_pre_ecmo": {
          "distribution": "normal",
          "mean": 30,
          "std": 15,
          "clip_min": 10,
          "clip_max": 60
        },
        "murray_score": {
          "distribution": "normal",
          "mean": 3.0,
          "std": 0.5,
          "clip_min": 2.0,
          "clip_max": 4.0
        },
        "peep_level": {
          "distribution": "normal",
          "mean": 12,
          "std": 4,
          "clip_min": 5,
          "clip_max": 25
        },
        "immunocompromised": {
          "distribution": "choice",
          "values": [true, false],
          "probabilities": [0.3, 0.7]
        },
        "prone_positioning": {
          "distribution": "choice",
          "values": [true, false],
          "probabilities": [0.6, 0.4]
        },
        "pre_ecmo_ph": {
          "distribution": "normal",
          "mean": 7.25,
          "std": 0.15,
          "clip_min": 6.8,
          "clip_max": 7.6
        },
        "pre_ecmo_pco2": {
          "distribution": "normal",
          "mean": 50,
          "std": 15,
          "clip_min": 20,
          "clip_max": 100
        },
        "pre_ecmo_po2": {
          "distribution": "normal",
          "mean": 80,
          "std": 25,
          "clip_min": 30,
          "clip_max": 150
        },
        "creatinine_pre": {
          "distribution": "exponential",
          "scale": 1.5,
          "clip_min": 0.5,
          "clip_max": 8
        },
        "platelet_count_pre": {
          "distribution": "normal",
          "mean": 200,
          "std": 80,
          "clip_min": 20,
          "clip_max": 500
        }
      },
      "survival_outcome_model": {
        "formula": "1 / (1 + exp(risk_factors))",
        "description": "Logistic function for survival probability",
        "risk_factors_formula": "age_effect + nirs_effect + lactate_effect + random_variation",
        "coefficients": {
          "age_effect": {
            "formula": "(age_years - 50) * 0.02",
            "baseline": 50,
            "coefficient": 0.02
          },
          "nirs_effect": {
            "formula": "(cerebral_so2_baseline - 70) * -0.03",
            "baseline": 70,
            "coefficient": -0.03,
            "note": "Negative coefficient means higher rSO2 reduces risk"
          },
          "lactate_effect": {
            "formula": "(pre_ecmo_lactate - 2) * 0.1",
            "baseline": 2,
            "coefficient": 0.1
          },
          "random_variation": {
            "distribution": "normal",
            "mean": 0,
            "std": 0.5
          }
        },
        "sampling": "binomial with calculated probability",
        "code_line": 468
      }
    }
  },
  "nirs_features_module": {
    "file": "nirs/features.py",
    "lines": 14,
    "purpose": "Lightweight NIRS feature engineering utilities",
    "functions": {
      "fixed_window": {
        "line": 3,
        "parameters": {
          "df": "DataFrame with timestamp column",
          "start": "10:00",
          "end": "11:00",
          "time_col": "timestamp"
        },
        "description": "Filters dataframe to specific time window",
        "returns": "Filtered DataFrame copy"
      },
      "nirs_feature_frame": {
        "line": 6,
        "parameters": {
          "df": "DataFrame with NIRS data",
          "side_col": "side",
          "value_cols": ["hbo", "hbt", "pump_rpm", "flow_l_min"]
        },
        "side_filter": "non_cannulated",
        "features_calculated": {
          "mean": "s.mean() for each value column",
          "std": "s.std() for each value column",
          "slope": "(last_value - first_value) / max(length-1, 1)"
        },
        "returns": "Single-row DataFrame with calculated features",
        "note": "Alternative NIRS feature calculation not used in main risk model"
      }
    }
  }
}