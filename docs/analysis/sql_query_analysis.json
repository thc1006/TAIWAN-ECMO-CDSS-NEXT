{
  "analysis_metadata": {
    "analysis_date": "2025-09-30",
    "files_analyzed": [
      "sql/identify_ecmo.sql (267 lines)",
      "sql/mimic_ecmo_itemids.sql (1 line)"
    ],
    "analyzer": "Code Quality Analyzer Agent",
    "version": "1.0"
  },

  "query_structure": {
    "primary_query": "sql/identify_ecmo.sql",
    "total_lines": 267,
    "query_components": 3,

    "cte_definitions": [
      {
        "name": "ecmo_procedures",
        "lines": "17-44",
        "purpose": "Identify ECMO from ICD-10-PCS and ICD-9 procedure codes",
        "output_columns": [
          "subject_id",
          "hadm_id",
          "seq_num",
          "icd_code",
          "icd_version",
          "procedure_description",
          "identification_method"
        ]
      },
      {
        "name": "ecmo_medications",
        "lines": "46-63",
        "purpose": "Identify ECMO-related medications and high-dose vasopressors",
        "output_columns": [
          "subject_id",
          "hadm_id",
          "starttime",
          "endtime",
          "medication_name",
          "identification_method"
        ]
      },
      {
        "name": "ecmo_chartevents",
        "lines": "65-97",
        "purpose": "Identify ECMO from monitoring data and chartevents",
        "output_columns": [
          "subject_id",
          "hadm_id",
          "stay_id",
          "charttime",
          "itemid",
          "label",
          "value",
          "valuenum",
          "identification_method"
        ]
      },
      {
        "name": "ecmo_notes",
        "lines": "99-120",
        "purpose": "Identify ECMO mentions from clinical notes",
        "output_columns": [
          "subject_id",
          "hadm_id",
          "chartdate",
          "category",
          "description",
          "identification_method"
        ]
      },
      {
        "name": "all_ecmo_episodes",
        "lines": "123-131",
        "purpose": "Combine all identification methods using UNION",
        "output_columns": [
          "subject_id",
          "hadm_id",
          "identification_method"
        ]
      },
      {
        "name": "ecmo_episodes_summary",
        "lines": "134-142",
        "purpose": "Aggregate identification methods per patient/admission",
        "output_columns": [
          "subject_id",
          "hadm_id",
          "identification_methods",
          "num_identification_methods"
        ]
      }
    ],

    "supplementary_queries": [
      {
        "name": "ECMO Timeline and Parameters",
        "lines": "192-221",
        "purpose": "Extract time-series ECMO monitoring parameters",
        "parameter_categories": ["flow", "pressure", "ventilator", "temperature", "other"]
      },
      {
        "name": "ECMO Outcomes and Complications",
        "lines": "223-252",
        "purpose": "Identify complications and outcomes from diagnosis codes",
        "complication_types": [
          "Device_complication (T82.%)",
          "Coagulopathy (D65, D68.%)",
          "Acute_kidney_injury (N17.%)",
          "Brain_injury (G93.%)"
        ]
      }
    ]
  },

  "database_tables_referenced": {
    "mimiciv_hosp_schema": [
      {
        "table": "mimiciv_hosp.procedures_icd",
        "alias": "p",
        "columns_used": ["subject_id", "hadm_id", "seq_num", "icd_code", "icd_version"],
        "purpose": "Source of procedure codes for ECMO identification"
      },
      {
        "table": "mimiciv_hosp.d_icd_procedures",
        "alias": "d",
        "columns_used": ["icd_code", "icd_version", "long_title"],
        "purpose": "Procedure code descriptions"
      },
      {
        "table": "mimiciv_hosp.patients",
        "alias": "p",
        "columns_used": ["subject_id", "gender", "anchor_age"],
        "purpose": "Patient demographics"
      },
      {
        "table": "mimiciv_hosp.admissions",
        "alias": "a",
        "columns_used": [
          "hadm_id",
          "subject_id",
          "admittime",
          "dischtime",
          "deathtime",
          "admission_type",
          "admission_location",
          "discharge_location"
        ],
        "purpose": "Admission details and outcomes"
      },
      {
        "table": "mimiciv_hosp.diagnoses_icd",
        "alias": "d",
        "columns_used": ["hadm_id", "icd_code"],
        "purpose": "Diagnosis codes for complications"
      }
    ],

    "mimiciv_icu_schema": [
      {
        "table": "mimiciv_icu.prescriptions",
        "alias": "p",
        "columns_used": ["subject_id", "hadm_id", "starttime", "endtime", "drug", "dose_val_rx"],
        "purpose": "Medication prescriptions for ECMO-related drugs"
      },
      {
        "table": "mimiciv_icu.chartevents",
        "alias": "c",
        "columns_used": [
          "subject_id",
          "hadm_id",
          "stay_id",
          "charttime",
          "itemid",
          "value",
          "valuenum",
          "valueuom"
        ],
        "purpose": "Time-series monitoring data for ECMO parameters"
      },
      {
        "table": "mimiciv_icu.d_items",
        "alias": "d",
        "columns_used": ["itemid", "label", "category"],
        "purpose": "Item definitions for chartevents"
      }
    ],

    "mimiciv_note_schema": [
      {
        "table": "mimiciv_note.noteevents",
        "alias": "n",
        "columns_used": ["subject_id", "hadm_id", "chartdate", "category", "description", "text"],
        "purpose": "Clinical notes for text-based ECMO identification"
      }
    ]
  },

  "join_conditions": {
    "ecmo_procedures_cte": [
      {
        "type": "LEFT JOIN",
        "tables": "procedures_icd LEFT JOIN d_icd_procedures",
        "condition": "p.icd_code = d.icd_code AND p.icd_version = d.icd_version",
        "purpose": "Lookup procedure descriptions"
      }
    ],
    "ecmo_chartevents_cte": [
      {
        "type": "LEFT JOIN",
        "tables": "chartevents LEFT JOIN d_items",
        "condition": "c.itemid = d.itemid",
        "purpose": "Lookup item labels"
      }
    ],
    "main_query": [
      {
        "type": "LEFT JOIN",
        "tables": "ecmo_episodes_summary LEFT JOIN patients",
        "condition": "es.subject_id = p.subject_id",
        "purpose": "Add patient demographics"
      },
      {
        "type": "LEFT JOIN",
        "tables": "ecmo_episodes_summary LEFT JOIN admissions",
        "condition": "es.hadm_id = a.hadm_id",
        "purpose": "Add admission details"
      },
      {
        "type": "LEFT JOIN",
        "tables": "ecmo_episodes_summary LEFT JOIN ecmo_procedures",
        "condition": "es.subject_id = ep.subject_id AND es.hadm_id = ep.hadm_id AND ep.seq_num = MIN(seq_num)",
        "purpose": "Get primary ECMO procedure (first occurrence)"
      }
    ]
  },

  "codes_and_identifiers": {
    "icd_10_pcs_codes": [
      {
        "code": "5A1522F",
        "description": "ECMO continuous 24-96 hours",
        "category": "Extracorporeal Assistance and Performance"
      },
      {
        "code": "5A1532F",
        "description": "ECMO continuous >96 hours",
        "category": "Extracorporeal Assistance and Performance"
      },
      {
        "code": "5A1522G",
        "description": "ECMO intermittent <6 hours/day",
        "category": "Extracorporeal Assistance and Performance"
      },
      {
        "code": "5A15223",
        "description": "Extracorporeal oxygenation, membrane",
        "category": "Extracorporeal Assistance and Performance"
      },
      {
        "code": "5A1935Z",
        "description": "Respiratory ventilation, less than 24 consecutive hours",
        "category": "Extracorporeal Assistance and Performance"
      }
    ],

    "icd_9_codes": [
      {
        "code": "3965",
        "description": "Extracorporeal membrane oxygenation",
        "category": "Operations on the cardiovascular system"
      },
      {
        "code": "3966",
        "description": "Percutaneous cardiopulmonary bypass",
        "category": "Operations on the cardiovascular system"
      }
    ],

    "complication_icd_codes": [
      {
        "code_pattern": "T82.%",
        "description": "Device complication",
        "purpose": "Identify device-related complications"
      },
      {
        "code_pattern": "D65, D68.%",
        "description": "Coagulopathy",
        "purpose": "Identify bleeding/clotting complications"
      },
      {
        "code_pattern": "N17.%",
        "description": "Acute kidney injury",
        "purpose": "Identify renal complications"
      },
      {
        "code_pattern": "G93.%",
        "description": "Brain injury",
        "purpose": "Identify neurological complications"
      }
    ],

    "medication_names": [
      {
        "pattern": "%heparin%",
        "purpose": "Anticoagulation for ECMO circuit",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%bivalirudin%",
        "purpose": "Alternative anticoagulation",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%argatroban%",
        "purpose": "Alternative anticoagulation (HIT)",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%norepinephrine%",
        "threshold": ">0.5 dose_val_rx",
        "purpose": "High-dose vasopressor suggesting cardiogenic shock (VA-ECMO)",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%epinephrine%",
        "threshold": ">0.3 dose_val_rx",
        "purpose": "High-dose vasopressor suggesting cardiogenic shock (VA-ECMO)",
        "case_sensitivity": "case-insensitive"
      }
    ],

    "chartevents_itemids": [
      {
        "itemid": 227287,
        "label": "ECMO Flow",
        "status": "requires_verification",
        "purpose": "ECMO circuit flow rate monitoring"
      },
      {
        "itemid": 227288,
        "label": "ECMO Sweep Gas",
        "status": "requires_verification",
        "purpose": "ECMO oxygenator sweep gas flow"
      },
      {
        "itemid": 227289,
        "label": "ECMO Pressure",
        "status": "requires_verification",
        "purpose": "ECMO circuit pressure monitoring"
      }
    ],

    "chartevents_label_patterns": [
      {
        "pattern": "%ecmo%flow%",
        "category": "flow",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%extracorporeal%flow%",
        "category": "flow",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%ecmo%pressure%",
        "category": "pressure",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%sweep%gas%",
        "category": "ventilator",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%oxygenator%",
        "category": "ventilator",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%cannula% AND %ecmo%",
        "category": "device",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%ecmo%circuit%",
        "category": "device",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%membrane%oxygenator%",
        "category": "device",
        "case_sensitivity": "case-insensitive"
      }
    ],

    "clinical_notes_text_patterns": [
      {
        "pattern": "%ecmo%",
        "purpose": "Direct ECMO mention",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%extracorporeal membrane oxygenation%",
        "purpose": "Full ECMO term",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%extracorporeal life support%",
        "purpose": "Alternative ECMO term",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%ecls%",
        "purpose": "ECLS abbreviation",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%cannul% AND %extracorporeal%",
        "purpose": "Cannulation procedure mention",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%decannul%",
        "purpose": "ECMO removal procedure",
        "case_sensitivity": "case-insensitive"
      },
      {
        "pattern": "%wean% AND %ecmo%",
        "purpose": "ECMO weaning process",
        "case_sensitivity": "case-insensitive"
      }
    ]
  },

  "identification_methods": {
    "method_1_procedure_code": {
      "method_name": "procedure_code",
      "confidence_level": "high",
      "description": "ICD-10-PCS or ICD-9 procedure codes definitively indicate ECMO",
      "sources": ["procedures_icd table"],
      "codes_used": ["5A1522F", "5A1532F", "5A1522G", "5A15223", "5A1935Z", "3965", "3966"],
      "false_positive_risk": "low",
      "false_negative_risk": "medium (undercoding)"
    },

    "method_2_ecmo_medication": {
      "method_name": "ecmo_medication",
      "confidence_level": "medium",
      "description": "Anticoagulation and high-dose vasopressors suggest ECMO support",
      "sources": ["prescriptions table"],
      "medications_used": ["heparin", "bivalirudin", "argatroban", "norepinephrine >0.5", "epinephrine >0.3"],
      "false_positive_risk": "high (these drugs used for non-ECMO patients)",
      "false_negative_risk": "low",
      "notes": "Should be combined with other methods for validation"
    },

    "method_3_chart_events": {
      "method_name": "chart_events",
      "confidence_level": "high",
      "description": "ECMO-specific monitoring parameters indicate active ECMO",
      "sources": ["chartevents table", "d_items table"],
      "parameters_used": ["flow rates", "pressures", "sweep gas", "oxygenator", "cannula", "circuit"],
      "false_positive_risk": "low",
      "false_negative_risk": "medium (not all ECMO parameters may be documented)",
      "notes": "Itemids 227287-227289 require verification in actual MIMIC-IV data dictionary"
    },

    "method_4_clinical_notes": {
      "method_name": "clinical_notes",
      "confidence_level": "medium",
      "description": "Text mentions of ECMO in clinical documentation",
      "sources": ["noteevents table"],
      "patterns_used": ["ecmo", "extracorporeal", "ecls", "cannulation", "decannulation", "weaning"],
      "false_positive_risk": "medium (past ECMO, family discussions)",
      "false_negative_risk": "low",
      "notes": "Natural language processing could improve specificity"
    },

    "combination_logic": {
      "aggregation_method": "UNION of all four methods",
      "confidence_scoring": "COUNT(DISTINCT identification_method) as num_identification_methods",
      "interpretation": {
        "4_methods": "Very high confidence - ECMO confirmed",
        "3_methods": "High confidence - likely ECMO",
        "2_methods": "Moderate confidence - review recommended",
        "1_method": "Low confidence - requires manual validation"
      },
      "sorting": "ORDER BY num_identification_methods DESC - highest confidence first"
    }
  },

  "ecmo_type_determination": {
    "logic": "CASE statement based on ICD codes and admission context",
    "rules": [
      {
        "condition": "icd_code IN ('5A1522F', '5A1532F', '5A1522G') AND (admission_type = 'URGENT' OR 'EMERGENCY' OR admission_location LIKE '%EMERGENCY%')",
        "result": "VA_likely",
        "rationale": "Emergency/urgent admissions more likely to be cardiogenic shock requiring VA-ECMO"
      },
      {
        "condition": "icd_code IN ('5A1522F', '5A1532F', '5A1522G') AND NOT emergency",
        "result": "VV_likely",
        "rationale": "Non-emergency admissions more likely to be respiratory failure requiring VV-ECMO"
      },
      {
        "condition": "Other cases",
        "result": "unknown",
        "rationale": "Insufficient information to determine ECMO type"
      }
    ],
    "limitations": [
      "Probabilistic determination only",
      "Clinical review required for confirmation",
      "Does not capture VA-VV hybrid configurations",
      "Emergency admissions can still have VV-ECMO for ARDS"
    ],
    "improvement_suggestions": [
      "Add diagnosis code analysis (cardiogenic shock vs respiratory failure)",
      "Include hemodynamic parameters (lactate, cardiac output)",
      "Check for specific cannulation configurations from procedure notes",
      "Analyze vasopressor dosing patterns"
    ]
  },

  "output_schema": {
    "main_query_columns": [
      {
        "column": "subject_id",
        "data_type": "INTEGER",
        "source": "patients.subject_id",
        "description": "Unique patient identifier"
      },
      {
        "column": "gender",
        "data_type": "VARCHAR",
        "source": "patients.gender",
        "description": "Patient gender"
      },
      {
        "column": "age_at_admission",
        "data_type": "INTEGER",
        "source": "patients.anchor_age",
        "description": "Patient age at admission"
      },
      {
        "column": "hadm_id",
        "data_type": "INTEGER",
        "source": "admissions.hadm_id",
        "description": "Unique hospital admission identifier"
      },
      {
        "column": "admittime",
        "data_type": "TIMESTAMP",
        "source": "admissions.admittime",
        "description": "Hospital admission timestamp"
      },
      {
        "column": "dischtime",
        "data_type": "TIMESTAMP",
        "source": "admissions.dischtime",
        "description": "Hospital discharge timestamp"
      },
      {
        "column": "deathtime",
        "data_type": "TIMESTAMP",
        "source": "admissions.deathtime",
        "description": "Death timestamp (NULL if survived)"
      },
      {
        "column": "admission_type",
        "data_type": "VARCHAR",
        "source": "admissions.admission_type",
        "description": "Type of admission (URGENT, EMERGENCY, ELECTIVE, etc.)"
      },
      {
        "column": "admission_location",
        "data_type": "VARCHAR",
        "source": "admissions.admission_location",
        "description": "Location patient admitted from"
      },
      {
        "column": "discharge_location",
        "data_type": "VARCHAR",
        "source": "admissions.discharge_location",
        "description": "Location patient discharged to"
      },
      {
        "column": "identification_methods",
        "data_type": "TEXT",
        "source": "STRING_AGG(DISTINCT identification_method, ', ')",
        "description": "Comma-separated list of identification methods",
        "calculation": "Aggregation of all methods that identified ECMO"
      },
      {
        "column": "num_identification_methods",
        "data_type": "INTEGER",
        "source": "COUNT(DISTINCT identification_method)",
        "description": "Number of different identification methods",
        "calculation": "Count of unique methods (1-4)"
      },
      {
        "column": "died_during_admission",
        "data_type": "INTEGER",
        "source": "CASE WHEN deathtime IS NOT NULL THEN 1 ELSE 0 END",
        "description": "Binary indicator of in-hospital mortality",
        "calculation": "Derived from deathtime"
      },
      {
        "column": "length_of_stay_days",
        "data_type": "NUMERIC",
        "source": "DATE_PART('day', dischtime - admittime)",
        "description": "Hospital length of stay in days",
        "calculation": "Date difference between discharge and admission"
      },
      {
        "column": "probable_ecmo_type",
        "data_type": "VARCHAR",
        "source": "CASE statement based on icd_code and admission_type",
        "description": "Probable ECMO configuration (VA_likely, VV_likely, unknown)",
        "calculation": "Derived from procedure codes and admission context"
      },
      {
        "column": "primary_ecmo_procedure",
        "data_type": "TEXT",
        "source": "d_icd_procedures.long_title for MIN(seq_num)",
        "description": "Description of first ECMO procedure code",
        "calculation": "Lookup from first procedure occurrence"
      }
    ],

    "query_2_timeline_columns": [
      {
        "column": "subject_id",
        "description": "Patient identifier"
      },
      {
        "column": "hadm_id",
        "description": "Admission identifier"
      },
      {
        "column": "stay_id",
        "description": "ICU stay identifier"
      },
      {
        "column": "charttime",
        "description": "Timestamp of parameter measurement"
      },
      {
        "column": "parameter_name",
        "description": "Name of ECMO parameter"
      },
      {
        "column": "value",
        "description": "Text value of parameter"
      },
      {
        "column": "valuenum",
        "description": "Numeric value of parameter"
      },
      {
        "column": "unit_of_measure",
        "description": "Unit of measurement"
      },
      {
        "column": "parameter_category",
        "description": "Category: flow, pressure, ventilator, temperature, other"
      }
    ],

    "query_3_outcomes_columns": [
      {
        "column": "subject_id",
        "description": "Patient identifier"
      },
      {
        "column": "hadm_id",
        "description": "Admission identifier"
      },
      {
        "column": "complications",
        "description": "Comma-separated list of complications"
      },
      {
        "column": "survived_to_discharge",
        "description": "Binary survival indicator"
      },
      {
        "column": "discharge_disposition",
        "description": "Categorized discharge location: home, rehabilitation, skilled_nursing, hospice, other"
      }
    ]
  },

  "performance_analysis": {
    "potential_bottlenecks": [
      {
        "location": "ecmo_notes CTE (lines 99-120)",
        "issue": "Full-text search on noteevents.text using LIKE patterns",
        "severity": "HIGH",
        "impact": "Very slow if noteevents table is large",
        "recommendation": "Create full-text index on noteevents.text or use PostgreSQL full-text search (tsvector)"
      },
      {
        "location": "ecmo_chartevents CTE (lines 65-97)",
        "issue": "Multiple ILIKE pattern matches on d_items.label",
        "severity": "MEDIUM",
        "impact": "Potentially slow with large chartevents table",
        "recommendation": "Pre-filter d_items for ECMO-related itemids, then join; consider materialized view"
      },
      {
        "location": "Main query JOIN on MIN(seq_num) subquery (lines 182-186)",
        "issue": "Correlated subquery for each row to find first procedure",
        "severity": "MEDIUM",
        "impact": "Could be slow with many ECMO procedures per admission",
        "recommendation": "Use window function ROW_NUMBER() OVER (PARTITION BY subject_id, hadm_id ORDER BY seq_num) instead"
      },
      {
        "location": "Query 2 IN clause (lines 212-214)",
        "issue": "Subquery IN clause for filtering chartevents",
        "severity": "LOW",
        "impact": "Minor performance issue",
        "recommendation": "Use INNER JOIN instead of IN clause for better optimization"
      },
      {
        "location": "STRING_AGG operations",
        "issue": "Multiple STRING_AGG operations for aggregation",
        "severity": "LOW",
        "impact": "Generally efficient in PostgreSQL",
        "recommendation": "No immediate action needed"
      }
    ],

    "missing_indexes_recommendations": [
      {
        "table": "mimiciv_hosp.procedures_icd",
        "columns": ["icd_code", "icd_version"],
        "reason": "Frequently filtered in WHERE clause"
      },
      {
        "table": "mimiciv_icu.prescriptions",
        "columns": ["drug"],
        "index_type": "GIN or text pattern ops",
        "reason": "Multiple LIKE pattern matches"
      },
      {
        "table": "mimiciv_icu.chartevents",
        "columns": ["itemid", "subject_id", "hadm_id"],
        "reason": "Frequently filtered and joined"
      },
      {
        "table": "mimiciv_note.noteevents",
        "columns": ["text"],
        "index_type": "Full-text index (tsvector + GIN)",
        "reason": "Multiple LIKE pattern searches on text field"
      }
    ],

    "optimization_recommendations": [
      {
        "priority": "HIGH",
        "recommendation": "Convert LIKE patterns on noteevents.text to full-text search",
        "code_example": "WHERE to_tsvector('english', n.text) @@ to_tsquery('ecmo | extracorporeal | ecls')",
        "expected_improvement": "10-100x faster text search"
      },
      {
        "priority": "MEDIUM",
        "recommendation": "Replace MIN(seq_num) correlated subquery with window function",
        "code_example": "WITH ranked_procedures AS (SELECT *, ROW_NUMBER() OVER (PARTITION BY subject_id, hadm_id ORDER BY seq_num) as rn FROM ecmo_procedures) ... WHERE rn = 1",
        "expected_improvement": "2-5x faster for patients with multiple procedures"
      },
      {
        "priority": "MEDIUM",
        "recommendation": "Create materialized view of ECMO-related d_items for faster label matching",
        "code_example": "CREATE MATERIALIZED VIEW ecmo_items AS SELECT * FROM d_items WHERE label ILIKE '%ecmo%' OR ...",
        "expected_improvement": "Faster chartevents filtering"
      },
      {
        "priority": "LOW",
        "recommendation": "Add EXPLAIN ANALYZE results to documentation",
        "expected_improvement": "Better understanding of actual query performance"
      }
    ]
  },

  "data_quality_issues": {
    "missing_codes_analysis": [
      {
        "issue": "Limited ICD-10-PCS codes",
        "description": "Only 5 ICD-10-PCS codes included; may miss other ECMO-related codes",
        "risk": "False negatives",
        "recommendation": "Review ELSO registry and add codes like 5A1522H (VA-ECMO), additional pump configurations"
      },
      {
        "issue": "No CPT codes included",
        "description": "Query mentions CPT in comments but doesn't filter CPT codes",
        "risk": "Missing ECMO episodes documented with CPT codes",
        "recommendation": "Add CPT codes: 33946-33989 (ECMO/ECLS procedures)"
      },
      {
        "issue": "Itemids not validated",
        "description": "Itemids 227287-227289 marked as requiring verification",
        "risk": "May not match actual MIMIC-IV data dictionary",
        "recommendation": "Run mimic_ecmo_itemids.sql to validate actual itemids in MIMIC-IV"
      },
      {
        "issue": "No weaning/decannulation timing",
        "description": "Query identifies episodes but not ECMO duration or weaning timeline",
        "risk": "Cannot calculate actual ECMO exposure time",
        "recommendation": "Add logic to identify cannulation/decannulation timestamps from procedures/notes"
      }
    ],

    "false_positive_risks": [
      {
        "source": "ecmo_medications",
        "risk_level": "HIGH",
        "description": "Heparin, bivalirudin, argatroban used for many non-ECMO patients",
        "mitigation": "Should only be used as supporting evidence, not sole identifier"
      },
      {
        "source": "ecmo_notes",
        "risk_level": "MEDIUM",
        "description": "Text mentions may refer to past ECMO, family discussions, or contraindications",
        "mitigation": "Use NLP to identify negation and temporal context"
      },
      {
        "source": "high-dose vasopressors",
        "risk_level": "MEDIUM",
        "description": "High-dose vasopressors used in septic shock, not just cardiogenic shock",
        "mitigation": "Combine with other evidence; consider diagnosis codes"
      }
    ],

    "false_negative_risks": [
      {
        "source": "procedure codes",
        "risk_level": "MEDIUM",
        "description": "Undercoding or miscoding of ECMO procedures",
        "mitigation": "Use multiple identification methods to compensate"
      },
      {
        "source": "chartevents",
        "risk_level": "MEDIUM",
        "description": "Not all ECMO parameters may be documented in structured format",
        "mitigation": "Validate itemids; consider adding more label patterns"
      },
      {
        "source": "medication data",
        "risk_level": "LOW",
        "description": "Medications may be documented in different formats or abbreviations",
        "mitigation": "Add more medication name variations"
      }
    ]
  },

  "validation_requirements": {
    "required_validation_steps": [
      {
        "step": 1,
        "action": "Run query on MIMIC-IV Demo database",
        "purpose": "Verify query executes without errors"
      },
      {
        "step": 2,
        "action": "Validate itemids using mimic_ecmo_itemids.sql",
        "purpose": "Confirm itemids 227287-227289 exist and are ECMO-related"
      },
      {
        "step": 3,
        "action": "Manual chart review of identified episodes",
        "purpose": "Validate true ECMO cases vs. false positives",
        "sample_size": "20-50 patients with varying num_identification_methods"
      },
      {
        "step": 4,
        "action": "Check for missed ECMO cases",
        "purpose": "Identify false negatives",
        "method": "Search for 'ECMO' in discharge summaries not captured by query"
      },
      {
        "step": 5,
        "action": "Validate ECMO type determination",
        "purpose": "Confirm VA vs VV classification accuracy",
        "method": "Compare predicted type with clinical documentation"
      },
      {
        "step": 6,
        "action": "Run EXPLAIN ANALYZE",
        "purpose": "Assess query performance and identify bottlenecks"
      }
    ],

    "quality_metrics_to_calculate": [
      {
        "metric": "Sensitivity (Recall)",
        "formula": "True Positives / (True Positives + False Negatives)",
        "target": ">90%"
      },
      {
        "metric": "Specificity",
        "formula": "True Negatives / (True Negatives + False Positives)",
        "target": ">95%"
      },
      {
        "metric": "Positive Predictive Value (Precision)",
        "formula": "True Positives / (True Positives + False Positives)",
        "target": ">90%"
      },
      {
        "metric": "Agreement by identification method count",
        "description": "Stratify accuracy by num_identification_methods (1-4)",
        "hypothesis": "Higher method count = higher accuracy"
      }
    ]
  },

  "elso_alignment": {
    "elso_data_dictionary_coverage": {
      "covered_fields": [
        "Patient demographics (age, gender)",
        "Admission/discharge dates",
        "Hospital mortality",
        "Length of stay",
        "ECMO type (VA/VV) - partial",
        "Complications (device, bleeding, renal, neurological)"
      ],
      "missing_critical_fields": [
        "Pre-ECMO diagnosis (respiratory failure, cardiac arrest, etc.)",
        "Cannulation site and configuration",
        "ECMO duration (hours)",
        "Pre-ECMO ventilator settings (FiO2, PEEP, PIP)",
        "Pre-ECMO hemodynamics (lactate, pH, PaO2/FiO2)",
        "ECMO flow rates over time",
        "Sweep gas settings over time",
        "Transfusion requirements",
        "Specific complications timeline",
        "Weaning success/failure",
        "Post-ECMO organ support"
      ]
    },

    "recommendations_for_elso_compliance": [
      {
        "priority": "HIGH",
        "recommendation": "Add pre-ECMO severity scoring",
        "fields_needed": [
          "SOFA score",
          "RESP score (for VV-ECMO)",
          "SAVE score (for VA-ECMO)",
          "Pre-ECMO lactate, pH, PaO2/FiO2"
        ]
      },
      {
        "priority": "HIGH",
        "recommendation": "Extract ECMO duration",
        "method": "Calculate from first to last ECMO-related chartevent timestamp"
      },
      {
        "priority": "MEDIUM",
        "recommendation": "Map complications to ELSO definitions",
        "action": "Create lookup table mapping ICD codes to ELSO complication categories"
      },
      {
        "priority": "MEDIUM",
        "recommendation": "Add cannulation details",
        "method": "NLP extraction from procedure notes for femoral-femoral, VV dual-lumen, etc."
      }
    ]
  },

  "code_quality_assessment": {
    "overall_quality_score": 7.5,
    "max_score": 10,

    "strengths": [
      "Well-structured with clear CTEs and comments",
      "Multiple identification methods increase robustness",
      "Comprehensive code coverage (ICD-9, ICD-10-PCS)",
      "Includes supplementary queries for timeline and outcomes",
      "Good use of STRING_AGG for method aggregation",
      "Explicit LEFT JOINs with clear purpose",
      "Usage notes and validation guidance included"
    ],

    "weaknesses": [
      "Performance issues with text search (HIGH severity)",
      "Itemids not validated against actual data dictionary",
      "ECMO type determination overly simplistic",
      "No temporal logic for ECMO duration",
      "Medication-based identification has high false positive risk",
      "No handling of missing data or NULL values",
      "Correlated subquery inefficiency"
    ],

    "critical_issues": [
      {
        "issue": "Full-text search performance",
        "severity": "HIGH",
        "line_numbers": "99-120",
        "impact": "Query may time out on large databases",
        "fix": "Implement PostgreSQL full-text search with GIN index"
      },
      {
        "issue": "Unvalidated itemids",
        "severity": "HIGH",
        "line_numbers": "91-96",
        "impact": "May return zero ECMO episodes if itemids are incorrect",
        "fix": "Run mimic_ecmo_itemids.sql and update itemids based on actual data"
      }
    ],

    "code_smells": [
      {
        "smell": "Magic numbers",
        "location": "Lines 61-62 (dose thresholds 0.5, 0.3)",
        "recommendation": "Define as named constants or configuration parameters"
      },
      {
        "smell": "Repeated ILIKE patterns",
        "location": "Multiple CTEs",
        "recommendation": "Create helper function or use arrays for pattern matching"
      },
      {
        "smell": "Long CTE definitions",
        "location": "ecmo_chartevents (33 lines)",
        "recommendation": "Consider breaking into smaller, focused CTEs"
      }
    ],

    "refactoring_opportunities": [
      {
        "opportunity": "Create reusable pattern matching function",
        "benefit": "DRY principle; easier to maintain search patterns",
        "estimated_effort": "1-2 hours"
      },
      {
        "opportunity": "Separate configuration from logic",
        "benefit": "Easier to update codes/itemids without modifying query structure",
        "estimated_effort": "2-3 hours"
      },
      {
        "opportunity": "Add data quality checks",
        "benefit": "Early warning of missing data or structural changes",
        "estimated_effort": "2-4 hours"
      }
    ]
  },

  "technical_debt_estimate": {
    "total_hours": 16,
    "breakdown": [
      {
        "task": "Performance optimization (full-text search, window functions)",
        "hours": 4,
        "priority": "HIGH"
      },
      {
        "task": "Validate and update itemids",
        "hours": 2,
        "priority": "HIGH"
      },
      {
        "task": "Improve ECMO type determination logic",
        "hours": 3,
        "priority": "MEDIUM"
      },
      {
        "task": "Add ECMO duration calculation",
        "hours": 3,
        "priority": "MEDIUM"
      },
      {
        "task": "Create unit tests and validation framework",
        "hours": 4,
        "priority": "MEDIUM"
      }
    ]
  },

  "next_steps": {
    "immediate_actions": [
      {
        "action": "Run mimic_ecmo_itemids.sql to validate itemids",
        "owner": "Data Engineer",
        "estimated_time": "30 minutes"
      },
      {
        "action": "Execute query on MIMIC-IV Demo and document results",
        "owner": "Data Analyst",
        "estimated_time": "1 hour"
      },
      {
        "action": "Implement performance optimizations",
        "owner": "Database Developer",
        "estimated_time": "4 hours"
      }
    ],

    "medium_term_actions": [
      {
        "action": "Conduct manual chart review validation",
        "owner": "Clinical SME + Data Analyst",
        "estimated_time": "8 hours"
      },
      {
        "action": "Enhance ECMO type classification with diagnosis codes",
        "owner": "Clinical Informatician",
        "estimated_time": "3 hours"
      },
      {
        "action": "Add ECMO duration and timeline extraction",
        "owner": "Data Engineer",
        "estimated_time": "3 hours"
      }
    ]
  }
}